---
- name: Check if firewalld service exists
  stat: path=/usr/lib/systemd/system/firewalld.service
  register: firewalld_service

- name: Ensure that firewalld is completely disabled
  service:
    name: firewalld
    state: stopped
    enabled: false
    masked: true
  become: true
  when: firewalld_service.stat.exists

- name: Remove nftables
  yum:
    name: nftables
    state: absent
  become: true

- name: Install dependencies
  yum:
    name:
      - iptables
      - perl-core
      - perl-libwww-perl
      - perl-LWP-Protocol-https
    state: installed
  become: true

- name: Pull ConfigServer Firewall package
  get_url:
    url: "https://download.configserver.com/csf.tgz"
    dest: "{{ csf_tgz }}"
    checksum: "{{ csf_checksum }}"
  become: true

- name: Extract csf.tgz
  unarchive:
    src: "{{ csf_tgz }}"
    dest: "{{ csf_unpack }}"
    remote_src: true
    creates: "{{ csf_unpack }}/csf/install.sh"
  become: true

- name: Install csf
  command:
    chdir: "{{ csf_unpack }}/csf"
    cmd: "sh {{ csf_unpack }}/csf/install.sh"
    creates: "/etc/csf/csf.conf"
  become: true

- name: Apply firewall configuration to /etc/csf/csf.conf
  template:
    src: "templates/{{ csf_conf_template }}"
    dest: /etc/csf/csf.conf
    owner: root
    group: root
    mode: 0600
  become: true
  notify:
    - Restart CSF
    - Restart LFD

- name: Ensure CSF is started and enabled in systemd
  service:
    name: csf
    state: started
    enabled: true
  become: true
  async: 15
  poll: 5
  register: csfstarted

- name: Ensure LFD is started and enabled in systemd
  service:
    name: lfd
    state: started
    enabled: true
  become: true
  async: 15
  poll: 5
  register: lfdstarted
